<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odor Nuisance Heatmap</title>
    <link rel="preconnect" href="https://maps.googleapis.com">
    <link rel="preconnect" href="https://maps.gstatic.com">
    <link rel="preconnect" href="https://web-production-0bd7a.up.railway.app">
    
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            background: #f8f8f8;
        }

        #status-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            font-size: 12px;
        }

        .status-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        #loading-progress {
            width: 100%;
            height: 2px;
            background: #f0f0f0;
            margin-top: 5px;
            display: none;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: #4caf50;
            transition: width 0.3s ease-in-out;
        }

        #refresh-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 8px 16px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #refresh-button:hover {
            background: #45a049;
        }

        #refresh-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="status-panel">
        <div id="cache-status" class="status-item"></div>
        <div id="map-status" class="status-item"></div>
        <div id="data-status" class="status-item"></div>
        <div id="loading-progress">
            <div id="progress-bar"></div>
        </div>
    </div>
    <button id="refresh-button" onclick="manualRefresh()" disabled>Refresh Data</button>

    <!-- Initial configuration -->
    <script>
        window.ENV = {
            GOOGLE_MAPS_API_KEY: '%%GOOGLE_MAPS_API_KEY%%'
        };
        
        window.mapConfig = {
            dataSource: 'https://web-production-0bd7a.up.railway.app/odor',
            refreshInterval: 60000,
            retryInterval: 5000,
            map: {
                initialZoom: 8,
                defaultCenter: { lat: 31.4117257, lng: 35.0818155 },
                defaultStyles: [
                    {
                        featureType: "landscape",
                        elementType: "geometry",
                        stylers: [{ color: "#A8E08D" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#a2daf2" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ visibility: "simplified" }]
                    },
                    {
                        featureType: "poi",
                        elementType: "geometry",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            },
            heatmap: {
                opacity: 0.7,
                initialRadius: 20,
                gradient: [
                    'rgba(102, 187, 106, 0)',
                    'rgba(255, 255, 0, 1)',
                    'rgba(255, 191, 0, 1)',
                    'rgba(255, 127, 0, 1)',
                    'rgba(255, 63, 0, 1)',
                    'rgba(255, 0, 0, 1)',
                    'rgba(139, 0, 0, 1)'
                ]
            }
        };

        // Track dependencies loading
        window.depsLoaded = {
            turf: false,
            googleMaps: false
        };
    </script>

    <!-- Main application code -->
    <script>
        (function() {
            'use strict';

            const CACHE_KEY = 'odor_heatmap_data';
            const CACHE_TIMESTAMP_KEY = 'odor_heatmap_timestamp';
            const CACHE_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours

            let map, heatmap;
            let currentRadius = window.mapConfig.heatmap.initialRadius;
            let isInitialLoad = true;
            let retryTimeout = null;
            let isUpdating = false;
            let updateInterval = null;

            function checkDependencies() {
                return window.depsLoaded.turf && window.depsLoaded.googleMaps;
            }

            function updateStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.className = `status-item status-${type}`;
                }
            }

            function updateProgressBar(visible, progress = 0) {
                const progressElement = document.getElementById('loading-progress');
                const progressBar = document.getElementById('progress-bar');
                progressElement.style.display = visible ? 'block' : 'none';
                progressBar.style.width = `${progress}%`;
            }

            function loadCachedData() {
                try {
                    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    if (cachedTimestamp) {
                        const timestamp = parseInt(cachedTimestamp);
                        const now = Date.now();
                        const age = now - timestamp;
                        
                        if (age < CACHE_MAX_AGE) {
                            const cachedData = localStorage.getItem(CACHE_KEY);
                            if (cachedData) {
                                updateStatus('cache-status', 
                                    `Using cached data from ${new Date(timestamp).toLocaleTimeString()}`, 
                                    'info');
                                return JSON.parse(cachedData);
                            }
                        } else {
                            updateStatus('cache-status', 'Cache expired', 'warning');
                        }
                    }
                } catch (error) {
                    console.warn('Error loading cached data:', error);
                    updateStatus('cache-status', 'Error loading cache', 'error');
                }
                return null;
            }

            function saveToCache(data) {
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                    updateStatus('cache-status', 'Cache updated', 'success');
                } catch (error) {
                    console.warn('Error saving to cache:', error);
                    updateStatus('cache-status', 'Failed to update cache', 'error');
                }
            }

            async function fetchData(retryCount = 0) {
                if (isUpdating || !checkDependencies()) return;
                
                isUpdating = true;
                document.getElementById('refresh-button').disabled = true;
                updateProgressBar(true, 0);

                try {
                    updateStatus('data-status', 'Fetching new data...', 'info');
                    updateProgressBar(true, 30);

                    const response = await fetch(`${window.mapConfig.dataSource}?t=${Date.now()}`, {
                        headers: {
                            'Accept-Encoding': 'gzip',
                            'Cache-Control': 'no-cache'
                        }
                    });

                    updateProgressBar(true, 60);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const geoJsonData = await response.json();
                    updateProgressBar(true, 90);
                    
                    saveToCache(geoJsonData);
                    updateHeatmap(geoJsonData);
                    
                    updateStatus('data-status', 
                        `Data updated successfully at ${new Date().toLocaleTimeString()}`, 
                        'success');
                    updateProgressBar(false);
                    
                    isInitialLoad = false;
                    isUpdating = false;
                    document.getElementById('refresh-button').disabled = false;

                    if (retryTimeout) {
                        clearTimeout(retryTimeout);
                        retryTimeout = null;
                    }

                } catch (error) {
                    console.error('Data fetch failed:', error);
                    handleFetchError(error, retryCount);
                }
            }

            function handleFetchError(error, retryCount) {
                updateProgressBar(false);
                isUpdating = false;
                document.getElementById('refresh-button').disabled = false;

                const cachedData = loadCachedData();
                if (cachedData) {
                    updateHeatmap(cachedData);
                    updateStatus('data-status', 
                        'Failed to fetch new data, using cached data', 
                        'warning');
                } else {
                    updateStatus('data-status', 
                        `Failed to load data. Retry ${retryCount + 1}`, 
                        'error');
                }

                const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 30000);
                retryTimeout = setTimeout(() => fetchData(retryCount + 1), retryDelay);
            }

            function updateHeatmap(geoJsonData) {
                const heatmapData = convertGeoJsonToHeatmapData(geoJsonData);
                
                if (!map) {
                    initializeMap(window.mapConfig.map.defaultCenter);
                }
                
                if (heatmapData.length > 0) {
                    requestAnimationFrame(() => {
                        heatmap.setData(heatmapData);
                    });
                }
            }

            function initializeMap(center) {
                updateStatus('map-status', 'Initializing map...', 'info');

                const mapOptions = {
                    zoom: window.mapConfig.map.initialZoom,
                    center: center,
                    mapTypeId: 'roadmap',
                    styles: window.mapConfig.map.defaultStyles,
                    optimized: true,
                    backgroundColor: '#f8f8f8',
                    clickableIcons: false,
                    tilt: 0
                };

                map = new google.maps.Map(document.getElementById('map'), mapOptions);

                heatmap = new google.maps.visualization.HeatmapLayer({
                    map,
                    radius: currentRadius,
                    opacity: window.mapConfig.heatmap.opacity,
                    gradient: window.mapConfig.heatmap.gradient,
                    maxIntensity: 5
                });

                let zoomTimeout;
                map.addListener('zoom_changed', () => {
                    clearTimeout(zoomTimeout);
                    zoomTimeout = setTimeout(updateHeatmapRadius, 100);
                });
                
                updateHeatmapRadius();
                updateStatus('map-status', 'Map initialized successfully', 'success');
            }

            function convertGeoJsonToHeatmapData(geoJson) {
                if (!window.turf) {
                    console.error('Turf.js not loaded');
                    updateStatus('map-status', 'Required libraries not loaded properly', 'error');
                    return [];
                }

                const heatmapPoints = [];
                let maxIntensity = 0;

                try {
                    window.turf.featureEach(geoJson, feature => {
                        if (feature.geometry?.type === "Point") {
                            const [lng, lat] = feature.geometry.coordinates;
                            if (isValidCoordinate(lat, lng)) {
                                const point = new google.maps.LatLng(lat, lng);
                                const intensity = feature.properties?.intensity || 1;
                                
                                maxIntensity = Math.max(maxIntensity, intensity);
                                heatmapPoints.push({
                                    location: point,
                                    weight: parseFloat(intensity)
                                });
                            }
                        }
                    });

                    if (heatmap && maxIntensity > 0) {
                        heatmap.set('maxIntensity', maxIntensity);
                    }

                    return heatmapPoints;
                } catch (error) {
                    console.error('Error processing GeoJSON data:', error);
                    updateStatus('data-status', 'Error processing map data', 'error');
                    return [];
                }
            }

            function isValidCoordinate(lat, lng) {
                return !isNaN(lat) && !isNaN(lng) && 
                       Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
            }

            function updateHeatmapRadius() {
                const zoom = map.getZoom();
                currentRadius = calculateRadiusForZoom(zoom);
                requestAnimationFrame(() => {
                    heatmap.set('radius', currentRadius);
                });
            }

            function calculateRadiusForZoom(zoom) {
                return Math.max(10, Math.pow(2, zoom-5));
            }

            function startUpdateInterval() {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                
                let lastFetchTime = Date.now();
                updateInterval = setInterval(() => {
                    const now = Date.now();
                    if (!isUpdating && (now - lastFetchTime >= window.mapConfig.refreshInterval)) {
                        lastFetchTime = now;
                        fetchData();
                    }
            }, window.mapConfig.refreshInterval);
            }

            // Global functions
            window.manualRefresh = function() {
                if (!isUpdating && checkDependencies()) {
                    fetchData();
                }
            };

            window.initializeMapWhenReady = function() {
                if (!checkDependencies()) {
                    updateStatus('map-status', 'Waiting for required libraries to load...', 'info');
                    return;
                }

                updateStatus('map-status', 'Loading map resources...', 'info');
                
                try {
                    const cachedData = loadCachedData();
                    if (cachedData) {
                        updateHeatmap(cachedData);
                    }

                    fetchData();
                    startUpdateInterval();
                    document.getElementById('refresh-button').disabled = false;
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    updateStatus('map-status', 'Failed to initialize map. Please refresh the page.', 'error');
                }
            };

        })();
    </script>

    <!-- Load dependencies -->
    <script>
        // Function to load Google Maps
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.ENV.GOOGLE_MAPS_API_KEY}&libraries=visualization&callback=googleMapsLoaded`;
            script.async = true;
            document.head.appendChild(script);
        }

        // Callback for Google Maps load
        window.googleMapsLoaded = function() {
            window.depsLoaded.googleMaps = true;
            checkAllDependencies();
        };

        // Callback for Turf.js load
        window.turfLoaded = function() {
            window.depsLoaded.turf = true;
            loadGoogleMapsScript();
        };

        // Check if all dependencies are loaded
        function checkAllDependencies() {
            if (window.depsLoaded.turf && window.depsLoaded.googleMaps) {
                window.initializeMapWhenReady();
            }
        }

        // Error handler for script loading
        function handleScriptError(scriptName) {
            updateStatus('map-status', `Failed to load ${scriptName}. Please refresh the page.`, 'error');
        }

        // Start loading dependencies
        document.addEventListener('DOMContentLoaded', function() {
            // Load Turf.js first
            const turfScript = document.createElement('script');
            turfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js';
            turfScript.onload = window.turfLoaded;
            turfScript.onerror = () => handleScriptError('Turf.js');
            document.head.appendChild(turfScript);
        });
    </script>
</body>
</html>
