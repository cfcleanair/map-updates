<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odor Nuisance Heatmap</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #lastUpdate {
            position: absolute;
            top: 10px;
            right: 60px;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }

        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff00001a;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="lastUpdate">Last updated: Never</div>
    <div id="loadingIndicator">
        <div class="spinner"></div>
        <div id="loadingText">Loading data...</div>
    </div>

    <!-- Load environment variables first -->
    <script>
        window.ENV = {
            GOOGLE_MAPS_API_KEY: '%%GOOGLE_MAPS_API_KEY%%'
        };
    </script>
    
    <!-- Load Google Maps with dynamic API key -->
    <script defer 
        src="https://maps.googleapis.com/maps/api/js?key=%%GOOGLE_MAPS_API_KEY%%&libraries=visualization">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    
    <script>
    (function() {
        'use strict';

        const Config = {
            dataSource: 'https://web-production-0bd7a.up.railway.app/odor',
            refreshInterval: 60000,
            retryInterval: 5000, // Retry interval for failed requests
            map: {
                initialZoom: 8,
                defaultCenter: { lat: 31.4117257, lng: 35.0818155 },
                defaultStyles: [
                    {
                        featureType: "landscape",
                        elementType: "geometry",
                        stylers: [{ color: "#A8E08D" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#a2daf2" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ visibility: "simplified" }]
                    },
                    {
                        featureType: "poi",
                        elementType: "geometry",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            },
            heatmap: {
                opacity: 0.7,
                initialRadius: 20,
                gradient: [
                    'rgba(102, 187, 106, 0)',
                    'rgba(255, 255, 0, 1)',
                    'rgba(255, 191, 0, 1)',
                    'rgba(255, 127, 0, 1)',
                    'rgba(255, 63, 0, 1)',
                    'rgba(255, 0, 0, 1)',
                    'rgba(139, 0, 0, 1)'
                ]
            }
        };

        let map, heatmap;
        let currentRadius = Config.heatmap.initialRadius;
        let isInitialLoad = true;
        let retryTimeout = null;

        async function fetchData(retryCount = 0) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingText = document.getElementById('loadingText');
            
            try {
                if (isInitialLoad) {
                    loadingIndicator.style.display = 'block';
                    loadingText.textContent = 'Loading initial data...';
                }

                const response = await fetch(`${Config.dataSource}?t=${Date.now()}`, {
                    headers: {
                        'Accept-Encoding': 'gzip',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const geoJsonData = await response.json();
                updateHeatmap(geoJsonData);
                updateLastUpdateTime();
                
                loadingIndicator.style.display = 'none';
                isInitialLoad = false;
                
                // Clear any existing retry timeout
                if (retryTimeout) {
                    clearTimeout(retryTimeout);
                    retryTimeout = null;
                }

            } catch (error) {
                console.error('Data fetch failed:', error);
                
                if (isInitialLoad) {
                    loadingText.textContent = `Loading failed. Retrying... (${retryCount + 1})`;
                }

                const lastUpdate = document.getElementById('lastUpdate');
                lastUpdate.textContent = `Error: Failed to load data. Retrying...`;
                lastUpdate.classList.add('error');

                // Retry with exponential backoff
                const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 30000);
                retryTimeout = setTimeout(() => fetchData(retryCount + 1), retryDelay);
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const lastUpdate = document.getElementById('lastUpdate');
            lastUpdate.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            lastUpdate.classList.remove('error');
        }

        function updateHeatmap(geoJsonData) {
            const heatmapData = convertGeoJsonToHeatmapData(geoJsonData);
            validateHeatmapData(heatmapData);
            
            if (!map) {
                initializeMap(Config.map.defaultCenter);
            }
            
            heatmap.setData(heatmapData);
        }

        function initializeMap(center) {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: Config.map.initialZoom,
                center: center,
                mapTypeId: 'roadmap',
                styles: Config.map.defaultStyles,
                minZoom: 6,  // Restrict zoom out
                maxZoom: 15, // Restrict zoom in
                restriction: {  // Restrict pan area
                    latLngBounds: {
                        north: 33.5,
                        south: 29.5,
                        east: 36.0,
                        west: 34.0
                    }
                }
            });

            heatmap = new google.maps.visualization.HeatmapLayer({
                map,
                radius: currentRadius,
                opacity: Config.heatmap.opacity,
                gradient: Config.heatmap.gradient,
                maxIntensity: 5  // Adjust based on your intensity scale
            });

            map.addListener('zoom_changed', updateHeatmapRadius);
            updateHeatmapRadius();
        }

        function convertGeoJsonToHeatmapData(geoJson) {
            const heatmapPoints = [];
            let maxIntensity = 0;

            turf.featureEach(geoJson, feature => {
                if (feature.geometry?.type === "Point") {
                    const [lng, lat] = feature.geometry.coordinates;
                    if (isValidCoordinate(lat, lng)) {
                        const point = new google.maps.LatLng(lat, lng);
                        const intensity = feature.properties?.intensity || 1;
                        
                        maxIntensity = Math.max(maxIntensity, intensity);
                        heatmapPoints.push({
                            location: point,
                            weight: parseFloat(intensity)
                        });
                    }
                }
            });

            // Adjust heatmap intensity if needed
            if (heatmap && maxIntensity > 0) {
                heatmap.set('maxIntensity', maxIntensity);
            }

            return heatmapPoints;
        }

        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) && 
                   Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
        }

        function updateHeatmapRadius() {
            const zoom = map.getZoom();
            currentRadius = calculateRadiusForZoom(zoom);
            heatmap.set('radius', currentRadius);
        }

        function calculateRadiusForZoom(zoom) {
            if (zoom < 9) return 15;
            if (zoom < 11) return 12;
            return Math.pow(2, zoom-5);
        }

        function validateHeatmapData(data) {
            if (!data || data.length === 0) {
                throw new Error('No valid data points found for visualization');
            }
        }

        // Initialize and start periodic updates
        window.onload = function() {
            fetchData(); // Initial load
            setInterval(() => {
                if (!retryTimeout) { // Only start new fetch if not in retry mode
                    fetchData();
                }
            }, Config.refreshInterval);
        };
    })();
    </script>
</body>
</html>
