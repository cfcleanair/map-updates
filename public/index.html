<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odor Nuisance Heatmap</title>
    <link rel="preconnect" href="https://maps.googleapis.com">
    <link rel="preconnect" href="https://maps.gstatic.com">
    <link rel="preconnect" href="https://web-production-0bd7a.up.railway.app">
    
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            background: #f8f8f8;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Initial configuration -->
    <script>
        window.ENV = {
            GOOGLE_MAPS_API_KEY: '%%GOOGLE_MAPS_API_KEY%%'
        };

        window.mapConfig = {
            dataSource: 'https://web-production-0bd7a.up.railway.app/odor',
            refreshInterval: 60000,
            retryInterval: 5000,
            map: {
                initialZoom: 8,
                defaultCenter: {
                    lat: 31.4117257,
                    lng: 35.0818155
                },
                defaultStyles: [
                    {
                        featureType: "landscape",
                        elementType: "geometry",
                        stylers: [{ color: "#A8E08D" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#a2daf2" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ visibility: "simplified" }]
                    },
                    {
                        featureType: "poi",
                        elementType: "geometry",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            },
            heatmap: {
                opacity: 0.7,
                initialRadius: 20,
                gradient: [
                    'rgba(102, 187, 106, 0)',
                    'rgba(255, 255, 0, 1)',
                    'rgba(255, 191, 0, 1)',
                    'rgba(255, 127, 0, 1)',
                    'rgba(255, 63, 0, 1)',
                    'rgba(255, 0, 0, 1)',
                    'rgba(139, 0, 0, 1)'
                ]
            }
        };

        // Track dependencies loading
        window.depsLoaded = {
            turf: false,
            googleMaps: false
        };
    </script>

    <!-- Main application code -->
    <script>
        (function() {
            'use strict';

            const CACHE_KEY = 'odor_heatmap_data';
            const CACHE_TIMESTAMP_KEY = 'odor_heatmap_timestamp';
            const CACHE_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours

            let map, heatmap;
            let currentRadius = window.mapConfig.heatmap.initialRadius;
            let retryTimeout = null;
            let updateInterval = null;

            function checkDependencies() {
                return window.depsLoaded.turf && window.depsLoaded.googleMaps;
            }

            function loadCachedData() {
                try {
                    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    if (cachedTimestamp) {
                        const timestamp = parseInt(cachedTimestamp);
                        const now = Date.now();
                        const age = now - timestamp;

                        if (age < CACHE_MAX_AGE) {
                            const cachedData = localStorage.getItem(CACHE_KEY);
                            if (cachedData) {
                                return JSON.parse(cachedData);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error loading cached data:', error);
                }
                return null;
            }

            function saveToCache(data) {
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                } catch (error) {
                    console.warn('Error saving to cache:', error);
                }
            }

            async function fetchData(retryCount = 0) {
                if (!checkDependencies()) return;

                try {
                    const response = await fetch(`${window.mapConfig.dataSource}?t=${Date.now()}`, {
                        headers: {
                            'Accept-Encoding': 'gzip',
                            'Cache-Control': 'no-cache'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const geoJsonData = await response.json();

                    saveToCache(geoJsonData);
                    updateHeatmap(geoJsonData);

                    if (retryTimeout) {
                        clearTimeout(retryTimeout);
                        retryTimeout = null;
                    }

                } catch (error) {
                    console.error('Data fetch failed:', error);
                    handleFetchError(error, retryCount);
                }
            }

            function handleFetchError(error, retryCount) {
                const cachedData = loadCachedData();
                if (cachedData) {
                    updateHeatmap(cachedData);
                }

                const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 30000);
                retryTimeout = setTimeout(() => fetchData(retryCount + 1), retryDelay);
            }

            function updateHeatmap(geoJsonData) {
                const heatmapData = convertGeoJsonToHeatmapData(geoJsonData);

                if (!map) {
                    initializeMap(window.mapConfig.map.defaultCenter);
                }

                if (heatmapData.length > 0) {
                    requestAnimationFrame(() => {
                        heatmap.setData(heatmapData);
                    });
                }
            }

            function initializeMap(center) {
                const mapOptions = {
                    zoom: window.mapConfig.map.initialZoom,
                    center: center,
                    mapTypeId: 'roadmap',
                    styles: window.mapConfig.map.defaultStyles,
                    optimized: true,
                    backgroundColor: '#f8f8f8',
                    clickableIcons: false,
                    tilt: 0
                };

                map = new google.maps.Map(document.getElementById('map'), mapOptions);

                heatmap = new google.maps.visualization.HeatmapLayer({
                    map,
                    radius: currentRadius,
                    opacity: window.mapConfig.heatmap.opacity,
                    gradient: window.mapConfig.heatmap.gradient,
                    maxIntensity: 5
                });

                let zoomTimeout;
                map.addListener('zoom_changed', () => {
                    clearTimeout(zoomTimeout);
                    zoomTimeout = setTimeout(updateHeatmapRadius, 100);
                });

                updateHeatmapRadius();
            }

            function convertGeoJsonToHeatmapData(geoJson) {
                if (!window.turf) {
                    console.error('Turf.js not loaded');
                    return [];
                }

                const heatmapPoints = [];
                let maxIntensity = 0;

                try {
                    window.turf.featureEach(geoJson, feature => {
                        if (feature.geometry?.type === "Point") {
                            const [lng, lat] = feature.geometry.coordinates;
                            if (isValidCoordinate(lat, lng)) {
                                const point = new google.maps.LatLng(lat, lng);
                                const intensity = feature.properties?.intensity || 1;

                                maxIntensity = Math.max(maxIntensity, intensity);
                                heatmapPoints.push({
                                    location: point,
                                    weight: parseFloat(intensity)
                                });
                            }
                        }
                    });

                    if (heatmap && maxIntensity > 0) {
                        heatmap.set('maxIntensity', maxIntensity);
                    }

                    return heatmapPoints;
                } catch (error) {
                    console.error('Error processing GeoJSON data:', error);
                    return [];
                }
            }

            function isValidCoordinate(lat, lng) {
                return !isNaN(lat) && !isNaN(lng) &&
                    Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
            }

            function updateHeatmapRadius() {
                const zoom = map.getZoom();
                currentRadius = calculateRadiusForZoom(zoom);
                requestAnimationFrame(() => {
                    heatmap.set('radius', currentRadius);
                });
            }

            function calculateRadiusForZoom(zoom) {
                return Math.max(10, Math.pow(2, zoom - 5));
            }

            function startUpdateInterval() {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }

                let lastFetchTime = Date.now();
                updateInterval = setInterval(() => {
                    const now = Date.now();
                    if (now - lastFetchTime >= window.mapConfig.refreshInterval) {
                        lastFetchTime = now;
                        fetchData();
                    }
                }, window.mapConfig.refreshInterval);
            }

            window.initializeMapWhenReady = function() {
                if (!checkDependencies()) {
                    return;
                }

                try {
                    const cachedData = loadCachedData();
                    if (cachedData) {
                        updateHeatmap(cachedData);
                    }

                    fetchData();
                    startUpdateInterval();

                } catch (error) {
                    console.error('Initialization error:', error);
                }
            };
        })();
    </script>

    <!-- Load dependencies -->
    <script>
        // Function to load Google Maps
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.ENV.GOOGLE_MAPS_API_KEY}&libraries=visualization&callback=googleMapsLoaded`;
            script.async = true;
            document.head.appendChild(script);
        }

        // Callback for Google Maps load
        window.googleMapsLoaded = function() {
            window.depsLoaded.googleMaps = true;
            checkAllDependencies();
        };

        // Callback for Turf.js load
        window.turfLoaded = function() {
            window.depsLoaded.turf = true;
            loadGoogleMapsScript();
        };

        // Check if all dependencies are loaded
        function checkAllDependencies() {
            if (window.depsLoaded.turf && window.depsLoaded.googleMaps) {
                window.initializeMapWhenReady();
            }
        }

        // Error handler for script loading
        function handleScriptError(scriptName) {
            console.error(`Failed to load ${scriptName}. Please refresh the page.`);
        }

        // Start loading dependencies
        document.addEventListener('DOMContentLoaded', function() {
            // Load Turf.js first
            const turfScript = document.createElement('script');
            turfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js';
            turfScript.onload = window.turfLoaded;
            turfScript.onerror = () => handleScriptError('Turf.js');
            document.head.appendChild(turfScript);
        });
    </script>
</body>
</html>
